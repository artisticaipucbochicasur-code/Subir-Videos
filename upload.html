<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subir video a DECOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" />
    <style>
      /* ... mismos estilos ... */
      * { box-sizing: border-box; }
      body { margin: 0; font-family: "Segoe UI", sans-serif; background-color: #f0f4f8; color: #333; position: relative; padding-top: 160px; }
      .logo-container { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-height: 200px; z-index: 2; text-align: center; background-color: transparent; }
      .logo-container img { max-width: 100%; height: auto; object-fit: contain; }
      main { max-width: 1200px; width: 95%; margin: 0 auto; background-color: #fff; border-radius: 14px; padding: 30px 25px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); text-align: center; position: relative; z-index: 1; }
      h2 { font-family: 'Luckiest Guy', cursive; font-size: 36px; margin-bottom: 30px; color: #2b6cb0; }
      .input-group { margin-bottom: 20px; text-align: left; }
      label { display: block; margin-bottom: 8px; font-weight: bold; color: #2b6cb0; font-size: 18px; }
      input[type="file"] { padding: 18px; font-size: 18px; width: 100%; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #90cdf4; background-color: #ebf8ff; }
      input[type="text"] { padding: 16px; font-size: 18px; width: 100%; border-radius: 10px; border: 2px solid #90cdf4; background-color: #ebf8ff; margin-bottom: 10px; box-sizing: border-box; }
      input[type="text"]:required { border-color: #e53e3e; }
      button { padding: 16px 24px; font-size: 20px; background-color: #2b6cb0; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; margin-bottom: 15px; transition: background-color 0.3s ease, transform 0.2s ease; }
      button:hover { background-color: #2c5282; transform: scale(1.02); }
      #copyButton { background-color: #38a169; }
      #copyButton:hover { background-color: #2f855a; }
      #retryButton { background-color: #e53e3e; display: none; }
      #retryButton:hover { background-color: #c53030; }
      #deleteButton { background-color: #d53f8c; }
      #deleteButton:hover { background-color: #b83280; }
      #deleteArea { margin-bottom: 20px; }
      #progressContainer { width: 100%; margin-top: 20px; display: none; }
      #progressBar { width: 100%; height: 20px; background-color: #e2e8f0; border-radius: 10px; overflow: hidden; }
      #progress { height: 100%; width: 0%; background-color: #3182ce; transition: width 0.3s ease; }
      #status { margin-top: 20px; font-size: 16px; color: #444; }
      .note { font-size: 16px; color: #555; margin-top: 30px; background-color: #edf2f7; padding: 20px; border-radius: 10px; line-height: 1.6; }
      a { color: #2b6cb0; word-break: break-word; font-size: 14px; }
      select { padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid #90cdf4; margin-bottom: 10px; width: 100%; max-width: 400px; }
      @media (max-width: 600px) {
        body { padding-top: 140px; }
        h2 { font-size: 28px; }
        input[type="file"], input[type="text"], button, select { font-size: 16px; padding: 14px; }
        .note { font-size: 14px; }
        label { font-size: 16px; }
      }
    </style>
  </head>
  <body>
    <div class="logo-container">
      <img src="logo.png" alt="Logo" />
    </div>
    <main>
      <h2>DECOM BOCHICA SUR</h2>
      <form id="uploadForm" onsubmit="event.preventDefault(); upload();">
        <div class="input-group">
          <label for="videoTitle">T√≠tulo del video <span style="color: #e53e3e">*</span></label>
          <input type="text" id="videoTitle" placeholder="Escribe el t√≠tulo del video" maxlength="80" required />
        </div>
        <input type="file" id="fileInput" accept="video/*" required />
        <button type="submit">üì§ Subir video</button>
      </form>
      <div id="progressContainer">
        <div id="progressBar">
          <div id="progress"></div>
        </div>
      </div>
      <div id="status"></div>
      <button id="copyButton" onclick="copiar()">üìã Copiar link directo</button>
      <button id="retryButton" onclick="upload()">üîÅ Reintentar</button>
      <div id="deleteArea">
        <select id="deleteSelect">
          <option value="">Selecciona una publicaci√≥n para eliminar</option>
        </select>
        <button id="deleteButton" onclick="eliminarSeleccionada()">üóëÔ∏è Eliminar publicaci√≥n</button>
      </div>
      <div class="note">
        üîÑ Por favor, espera hasta que el video se suba completamente.<br /><br />
        üìã El link ser√° guardado autom√°ticamente en la hoja de c√°lculo.<br /><br />
        ‚úÖ Luego presiona <strong>‚ÄúPublivar Video‚Äù</strong> en la app para finalizar.<br /><br />
        Desarrollada por: DEIMER HERRERA.
      </div>
    </main>
    <script>
      let directLink = "";
      let identifier = "";
      let fileName = "";
      let tituloUsuario = "";

      document.addEventListener("DOMContentLoaded", cargarPublicaciones);

      function cargarPublicaciones() {
        // ‚úÖ Ahora usa listarWeb y valida la respuesta
        fetch('https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec?accion=listarWeb')
          .then(response => response.json())
          .then(data => {
            const select = document.getElementById("deleteSelect");
            select.innerHTML = '<option value="">Selecciona una publicaci√≥n para eliminar</option>';

            if (data.status === "success" && Array.isArray(data.publicaciones)) {
              data.publicaciones.forEach(pub => {
                if (pub.titulo && pub.link) {
                  select.innerHTML += `<option value="${pub.link}">${pub.titulo}</option>`;
                }
              });
            }
          })
          .catch(err => {
            console.error("Error al cargar publicaciones:", err);
          });
      }

      function upload() {
        const file = document.getElementById("fileInput").files[0];
        tituloUsuario = document.getElementById("videoTitle").value.trim();

        if (!file) {
          alert("Selecciona un video primero.");
          document.getElementById("fileInput").focus();
          return;
        }

        if (!tituloUsuario) {
          alert("Por favor, escribe el t√≠tulo del video.");
          document.getElementById("videoTitle").focus();
          return;
        }

        document.getElementById("retryButton").style.display = "none";
        document.getElementById("copyButton").style.display = "none";
        document.getElementById("status").innerText = "";

        identifier = "artistica_bochica_" + Date.now();
        fileName = file.name;
        const accessKey = "KPJmAQCm1UyNJWqv";
        const secretKey = "9JkBrIGexGNOynyf";

        const url = `https://s3.us.archive.org/${identifier}/${fileName}`;
        const xhr = new XMLHttpRequest();

        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            document.getElementById("progressContainer").style.display = "block";
            document.getElementById("progress").style.width = percent + "%";
          }
        };

        xhr.onload = function () {
          if (xhr.status === 200) {
            const fileEncoded = encodeURIComponent(fileName);
            directLink = `https://archive.org/download/${identifier}/${fileEncoded}`;
            document.getElementById("status").innerHTML = `
              <p>‚úÖ Publicaci√≥n exitosa.</p>
              <a href="${directLink}" target="_blank">üîó Ver video</a>`;
            document.getElementById("copyButton").style.display = "inline-block";
            document.getElementById("retryButton").style.display = "none";

            // Guardar en hoja de c√°lculo
            fetch('https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec?accion=guardar&tipo=video&titulo='
              + encodeURIComponent(tituloUsuario)
              + '&link=' + encodeURIComponent(directLink), {
              method: 'GET'
            }).then(cargarPublicaciones);

          } else {
            document.getElementById("status").innerText = "‚ùå Error al subir: " + xhr.responseText;
            document.getElementById("retryButton").style.display = "inline-block";
          }
        };

        xhr.onerror = function () {
          document.getElementById("status").innerText = "‚ùå Error de red al subir el archivo.";
          document.getElementById("retryButton").style.display = "inline-block";
        };

        xhr.open("PUT", url, true);
        xhr.setRequestHeader("Authorization", `LOW ${accessKey}:${secretKey}`);
        xhr.setRequestHeader("x-archive-auto-make-bucket", "1");
        xhr.setRequestHeader("x-archive-meta-title", fileName);
        xhr.setRequestHeader("x-archive-meta-mediatype", "movies");
        xhr.setRequestHeader("x-archive-meta-description", "Video subido desde la app DECOM");
        xhr.setRequestHeader("x-archive-meta-collection", "opensource_movies");
        xhr.setRequestHeader("x-archive-meta-creator", "artistica_bochica");
        xhr.setRequestHeader("Content-Type", file.type);

        xhr.send(file);
      }

      function copiar() {
        if (!directLink) return;
        navigator.clipboard
          .writeText(directLink)
          .then(() => alert("‚úÖ Link copiado al portapapeles"))
          .catch(() => alert("‚ùå No se pudo copiar"));
      }

      function eliminarSeleccionada() {
        const select = document.getElementById("deleteSelect");
        const link = select.value;
        const titulo = select.options[select.selectedIndex]?.text;

        if (!link) {
          alert("Selecciona una publicaci√≥n para eliminar.");
          return;
        }

        // Eliminar de Archive.org
        let archiveMatch = link.match(/archive\.org\/download\/(artistica_bochica_\d+)\/(.+)$/);
        if (!archiveMatch) {
          alert("No se pudo encontrar la ruta del archivo en Archive.org.");
          return;
        }
        let delIdentifier = archiveMatch[1];
        let delFileName = decodeURIComponent(archiveMatch[2]);

        const url = `https://s3.us.archive.org/${delIdentifier}/${delFileName}`;
        const accessKey = "KPJmAQCm1UyNJWqv";
        const secretKey = "9JkBrIGexGNOynyf";
        const xhr = new XMLHttpRequest();

        xhr.open("DELETE", url, true);
        xhr.setRequestHeader("Authorization", `LOW ${accessKey}:${secretKey}`);

        xhr.onload = function () {
          if (xhr.status === 200 || xhr.status === 204) {
            document.getElementById("status").innerHTML = `<p>üóëÔ∏è Publicaci√≥n eliminada de Archive.org.</p>`;
            // Eliminar de hoja de c√°lculo
            fetch('https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec?accion=eliminar&link='
              + encodeURIComponent(link), {
              method: 'GET'
            }).then(cargarPublicaciones);
            select.selectedIndex = 0;
          } else {
            document.getElementById("status").innerHTML += "<br>‚ö†Ô∏è Error al eliminar de Archive.org.";
          }
        };

        xhr.onerror = function () {
          document.getElementById("status").innerHTML += "<br>‚ö†Ô∏è Error de red al eliminar de Archive.org.";
        };

        xhr.send();
      }
    </script>
  </body>
</html>
