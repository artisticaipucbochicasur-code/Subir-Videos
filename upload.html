<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subir video a DECOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      body { margin: 0; font-family: "Segoe UI", sans-serif; background-color: #f0f4f8; color: #333; position: relative; padding-top: 160px; }
      .logo-container { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 100%; max-height: 200px; z-index: 2; text-align: center; background-color: transparent; }
      .logo-container img { max-width: 100%; height: auto; object-fit: contain; }
      main { max-width: 1200px; width: 95%; margin: 0 auto; background-color: #fff; border-radius: 14px; padding: 30px 25px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); text-align: center; position: relative; z-index: 1; }
      h2 { font-family: 'Luckiest Guy', cursive; font-size: 36px; margin-bottom: 30px; color: #2b6cb0; }
      .input-group { margin-bottom: 20px; text-align: left; }
      label { display: block; margin-bottom: 8px; font-weight: bold; color: #2b6cb0; font-size: 18px; }
      input[type="file"] { padding: 18px; font-size: 18px; width: 100%; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #90cdf4; background-color: #ebf8ff; }
      input[type="text"] { padding: 16px; font-size: 18px; width: 100%; border-radius: 10px; border: 2px solid #90cdf4; background-color: #ebf8ff; margin-bottom: 10px; box-sizing: border-box; }
      input[type="text"]:required { border-color: #e53e3e; }
      button { padding: 16px 24px; font-size: 20px; background-color: #2b6cb0; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; margin-bottom: 15px; transition: background-color 0.3s ease, transform 0.2s ease; }
      button:hover { background-color: #2c5282; transform: scale(1.02); }
      #progressContainer { width: 100%; margin-top: 20px; display: none; }
      #progressBar { width: 100%; height: 20px; background-color: #e2e8f0; border-radius: 10px; overflow: hidden; }
      #progress { height: 100%; width: 0%; background-color: #3182ce; transition: width 0.3s ease; }
      #status { margin-top: 20px; font-size: 16px; color: #444; }
      .note { font-size: 16px; color: #555; margin-top: 30px; background-color: #edf2f7; padding: 20px; border-radius: 10px; line-height: 1.6; }
      .upload-info { margin: 18px 0 32px 0; padding: 15px; background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 8px; font-size: 16px; }
      .upload-metrics { font-size: 15px; color: #2b6cb0; margin-top: 8px; }
      a { color: #2b6cb0; word-break: break-word; font-size: 14px; }
      select { padding: 12px; font-size: 16px; border-radius: 8px; border: 2px solid #90cdf4; margin-bottom: 10px; width: 100%; max-width: 400px; }
      @media (max-width: 600px) {
        body { padding-top: 140px; }
        h2 { font-size: 28px; }
        input[type="file"], input[type="text"], button, select { font-size: 16px; padding: 14px; }
        .note { font-size: 14px; }
        label { font-size: 16px; }
        .upload-info { font-size: 13px; }
      }
    </style>
  </head>
  <body>
    <div class="logo-container">
      <img src="logo.png" alt="Logo" />
    </div>
    <main>
      <h2>DECOM BOCHICA SUR</h2>

      <div class="upload-info" id="uploadInfo">
        <strong>Recomendaciones para subir videos grandes:</strong><br>
        ‚Ä¢ Para videos mayores a 100 MB, usa preferiblemente conexi√≥n WiFi.<br>
        ‚Ä¢ No cierres ni bloquees la pantalla durante la subida.<br>
        ‚Ä¢ La velocidad depende de tu internet, puede tardar varios minutos.<br>
        <b>Tip:</b> Si tu video es muy grande y la subida es lenta, prueba comprimirlo con una app externa como <a href="https://play.google.com/store/apps/details?id=com.pandavideo.compressor" target="_blank">Panda Video Compressor</a> o <a href="https://play.google.com/store/apps/details?id=com.xvideostudio.videoeditor" target="_blank">VidCompact</a> antes de subir.<br>
        <b>Tama√±o m√°ximo recomendado:</b> 200 MB.
      </div>

      <form id="uploadForm" onsubmit="event.preventDefault(); upload();">
        <div class="input-group">
          <label for="videoTitle">T√≠tulo del video <span style="color: #e53e3e">*</span></label>
          <input type="text" id="videoTitle" placeholder="Escribe el t√≠tulo del video" maxlength="80" required />
        </div>
        <div class="input-group">
          <label for="videoDescripcion">Descripci√≥n del video</label>
          <input type="text" id="videoDescripcion" placeholder="Agrega una breve descripci√≥n" maxlength="200" />
        </div>
        <input type="file" id="fileInput" accept="video/*" required />
        <button type="submit">üì§ Subir video</button>
      </form>

      <div id="progressContainer">
        <div id="progressBar">
          <div id="progress"></div>
        </div>
        <div class="upload-metrics" id="uploadMetrics"></div>
      </div>
      <div id="status"></div>
      <div class="note">
        üîÑ Por favor, espera hasta que el video se suba completamente.<br /><br />
        üìã La publicaci√≥n ser√° guardada autom√°ticamente en DECOM.<br /><br />
        ‚úÖ Luego ve a <strong>‚ÄúVideos‚Äù</strong> en la app para visualizar.<br /><br />
        Desarrollada por: DEIMER HERRERA.
      </div>
    </main>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const qs = new URLSearchParams(location.search);
  const qName  = qs.get("name");
  const qEmail = qs.get("email");
  if (qName)  localStorage.setItem("autor",  qName);
  if (qEmail) localStorage.setItem("correo", qEmail);

  try { window.AppInventor?.setWebViewString?.("REQUEST_USER_DATA"); } catch(e) {}

  if (window.AppInventor) {
    setInterval(() => {
      const comando = window.AppInventor.getWebViewString?.();
      if (!comando) return;
      try {
        const data = JSON.parse(comando);
        if (data.action === "updateUserData") {
          const currentAuthorName  = data.name  || "";
          const currentAuthorEmail = data.email || "";
          if (currentAuthorName)  localStorage.setItem("autor",  currentAuthorName);
          if (currentAuthorEmail) localStorage.setItem("correo", currentAuthorEmail);
          console.log("upload.html: datos recibidos de AppInventor", currentAuthorName, currentAuthorEmail);
        }
      } catch (e) {}
    }, 500);
  }
});

let directLink = "";

function humanFileSize(size) {
  if (size === 0) return "0 B";
  const i = Math.floor(Math.log(size) / Math.log(1024));
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  return (size / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
}

function upload() {
  const file = document.getElementById("fileInput").files[0];
  const tituloUsuario = document.getElementById("videoTitle").value.trim();
  const descripcionUsuario = document.getElementById("videoDescripcion").value.trim();

  const params = new URLSearchParams(window.location.search);
  const autor = params.get("nombre") || "An√≥nimoDH";
  const correo = params.get("email") || "decom@bochicasur.edu";

  if (!file) {
    alert("Selecciona un video primero.");
    document.getElementById("fileInput").focus();
    return;
  }

  if (!tituloUsuario) {
    alert("Por favor, escribe el t√≠tulo del video.");
    document.getElementById("videoTitle").focus();
    return;
  }

  document.getElementById("status").innerText = "";
  document.getElementById("uploadMetrics").innerText = "";
  document.getElementById("progress").style.width = "0%";
  document.getElementById("progressContainer").style.display = "block";

  // Mostrar info de tama√±o del video seleccionado
  document.getElementById("uploadInfo").innerHTML += `<br><b>Video seleccionado:</b> ${file.name} (${humanFileSize(file.size)})`;

  const identifier = "artistica_bochica_" + Date.now();
  const fileName = file.name;
  const accessKey = "KPJmAQCm1UyNJWqv";
  const secretKey = "9JkBrIGexGNOynyf";
  const url = `https://s3.us.archive.org/${identifier}/${fileName}`;
  const xhr = new XMLHttpRequest();

  let startTime = Date.now();

  xhr.upload.onprogress = function (event) {
    if (event.lengthComputable) {
      const percent = (event.loaded / event.total) * 100;
      document.getElementById("progress").style.width = percent + "%";

      // Mostrar progreso en MB y velocidad estimada
      const loadedMB = (event.loaded / (1024 * 1024)).toFixed(2);
      const totalMB = (event.total / (1024 * 1024)).toFixed(2);
      const elapsed = (Date.now() - startTime) / 1000;
      const speed = event.loaded / elapsed; // bytes/seg
      const speedMB = (speed / (1024 * 1024)).toFixed(2);
      let timeLeft = ((event.total - event.loaded) / speed);
      if (!isFinite(timeLeft)) timeLeft = 0;
      const mins = Math.floor(timeLeft / 60);
      const secs = Math.floor(timeLeft % 60);

      document.getElementById("uploadMetrics").innerText =
        `Subido: ${loadedMB} MB / ${totalMB} MB  ‚Äî  Velocidad: ${speedMB} MB/s  ‚Äî  Restante: ${mins}m ${secs}s`;
    }
  };

  xhr.onload = function () {
    if (xhr.status === 200) {
      const fileEncoded = encodeURIComponent(fileName);
      directLink = `https://archive.org/download/${identifier}/${fileEncoded}`;
      document.getElementById("status").innerHTML = `
        <p>‚úÖ Publicaci√≥n exitosa.</p>
        <a href="${directLink}" target="_blank">üîó Ver video</a>`;

      fetch('https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec?accion=guardar&tipo=video'
        + '&titulo=' + encodeURIComponent(tituloUsuario)
        + '&link=' + encodeURIComponent(directLink)
        + '&autor=' + encodeURIComponent(autor)
        + '&correo=' + encodeURIComponent(correo)
        + '&descripcion=' + encodeURIComponent(descripcionUsuario), {
        method: 'GET'
      });
      document.getElementById("uploadMetrics").innerText = "";
      document.getElementById("progressContainer").style.display = "none";
    } else {
      document.getElementById("status").innerText = "‚ùå Error al subir: " + xhr.responseText;
      document.getElementById("uploadMetrics").innerText = "";
    }
  };

  xhr.onerror = function () {
    document.getElementById("status").innerText = "‚ùå Error de red al subir el archivo.";
    document.getElementById("uploadMetrics").innerText = "";
  };

  xhr.open("PUT", url, true);
  xhr.setRequestHeader("Authorization", `LOW ${accessKey}:${secretKey}`);
  xhr.setRequestHeader("x-archive-auto-make-bucket", "1");
  xhr.setRequestHeader("x-archive-meta-title", fileName);
  xhr.setRequestHeader("x-archive-meta-mediatype", "movies");
  xhr.setRequestHeader("x-archive-meta-description", "Video subido desde la app DECOM");
  xhr.setRequestHeader("x-archive-meta-collection", "opensource_movies");
  xhr.setRequestHeader("x-archive-meta-creator", "artistica_bochica");
  xhr.setRequestHeader("Content-Type", file.type);

  xhr.send(file);
}
    </script>
  </body>
</html>
