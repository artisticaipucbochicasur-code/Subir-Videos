<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subir video a DECOM</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap" rel="stylesheet" />
    <style>
      /* ... todos tus estilos originales ... */
    </style>
  </head>
  <body>
    <div class="logo-container">
      <img src="logo.png" alt="Logo" />
    </div>
    <main>
      <h2>DECOM BOCHICA SUR</h2>
      <input type="file" id="fileInput" accept="video/*" />
      <input type="text" id="tituloInput" placeholder="Título del video" style="margin-bottom:15px;width:100%;padding:14px;font-size:16px;" />
      <button onclick="upload()">📤 Subir video</button>
      <div id="progressContainer">
        <div id="progressBar"><div id="progress"></div></div>
      </div>
      <div id="status"></div>
      <button id="copyButton" onclick="copiar()">📋 Copiar link directo</button>
      <button id="retryButton" onclick="upload()">🔁 Reintentar</button>
      <div class="note">
        🔄 Por favor, espera hasta que el video se suba completamente.<br /><br />
        📋 Una vez cargado, copia el link generado y pégalo en la <strong>descripción</strong> dentro de la app DECOM.<br /><br />
        ✅ Luego presiona <strong>“Guardar Anuncio”</strong> en la app para finalizar.
      </div>
    </main>
    <script>
      let directLink = "";
      function upload() {
        const file = document.getElementById("fileInput").files[0];
        const titulo = document.getElementById("tituloInput").value.trim();
        if (!file) { alert("Selecciona un video primero."); return; }
        if (!titulo) { alert("Ingresa un título para el video."); return; }

        document.getElementById("retryButton").style.display = "none";
        document.getElementById("copyButton").style.display = "none";
        document.getElementById("status").innerText = "";

        const formData = new FormData();
        formData.append("file", file);

        const xhr = new XMLHttpRequest();
        xhr.upload.onprogress = function (event) {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            document.getElementById("progressContainer").style.display = "block";
            document.getElementById("progress").style.width = percent + "%";
          }
        };

        xhr.onload = function () {
          if (xhr.status === 200) {
            let resp;
            try { resp = JSON.parse(xhr.responseText); } catch { resp = {}; }
            if (resp.status === "success" && resp.link) {
              directLink = resp.link;
              document.getElementById("status").innerHTML = `
                <p>✅ Subido correctamente.</p>
                <a href="${directLink}" target="_blank">🔗 Ver video</a>`;
              document.getElementById("copyButton").style.display = "inline-block";
              document.getElementById("retryButton").style.display = "none";
              // ⏩ Enviar el link y el título a la hoja automáticamente
              enviarLinkAScript(directLink, titulo);
            } else {
              document.getElementById("status").innerText = "❌ Error: " + (resp.message || xhr.responseText);
              document.getElementById("retryButton").style.display = "inline-block";
            }
          } else {
            document.getElementById("status").innerText = "❌ Error al subir: " + xhr.responseText;
            document.getElementById("retryButton").style.display = "inline-block";
          }
        };

        xhr.onerror = function () {
          document.getElementById("status").innerText = "❌ Error de red al subir el archivo.";
          document.getElementById("retryButton").style.display = "inline-block";
        };

        // La URL de tu Apps Script que recibe el archivo y retorna el link
        xhr.open("POST", "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec", true);
        xhr.send(formData);
      }

      // Esta función guarda el link y el título en tu hoja automáticamente
      function enviarLinkAScript(linkDrive, titulo) {
        // La misma URL de tu Apps Script pero con parámetros tipo video
        const url = "https://script.google.com/macros/s/AKfycbwyY6m3H8WD494cnoQbNXwspsZtD1sGu97yio9mk9DTozGSuyo6gHXB1W6HArcpYfP2/exec";
        // Usamos fetch para enviar los datos tipo "guardar video"
        const params = new URLSearchParams({
          accion: "guardar",
          tipo: "video",
          titulo: titulo,
          link: linkDrive
        });
        fetch(url + "?" + params.toString(), { method: "GET" })
          .then(res => res.text())
          .then(data => {
            // Opcional: mostrar confirmación
            document.getElementById("status").innerHTML += "<br>📋 Guardado en hoja de cálculo.";
          })
          .catch(() => {
            document.getElementById("status").innerHTML += "<br>❌ Error al guardar en hoja.";
          });
      }

      function copiar() {
        if (!directLink) return;
        navigator.clipboard
          .writeText(directLink)
          .then(() => alert("✅ Link copiado al portapapeles"))
          .catch(() => alert("❌ No se pudo copiar"));
      }
    </script>
  </body>
</html>
